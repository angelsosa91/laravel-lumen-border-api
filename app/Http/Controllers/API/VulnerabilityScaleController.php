<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\Controller;
use App\Models\VulnerabilityScale as Scale;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class VulnerabilityScaleController extends Controller
{
    public function all()
    {
        $data = Scale::all(); //orderBy("id", "asc")->get();
        //result
        return response()->json($data, 200);
    }

    public function allByType($type)
    {
        $data = Scale::where('fk_data_escala_tipo', $type)->get(); //orderBy("id", "asc")->get();
        //result
        return response()->json($data, 200);
    }

    //get order by rows
    public function show(Request $request)
    {
        //request
        $page = ($request->has('page')) ? intval($request->input('page')) : 1;
        $rows = ($request->has('rows')) ? intval($request->input('rows')) : 50;
        $sort = ($request->has('sort')) ? strval($request->input('sort')) : "id";
        $order = ($request->has('order')) ? strval($request->input('order')) : "asc";
        $offset = ($page-1)*$rows;
        //filters
        $search = DB::table('data_escala_vulnerabilidad as s')
            ->join('data_escala_tipo as t', 't.id', '=', 's.fk_data_escala_tipo')
            ->select('s.id', 's.fk_data_escala_tipo as categoria', 's.descripcion', 's.puntaje', 't.tipo')
            ->where('s.id', '>', 0);
        //count
        $count = $search->count();
        //This field uses a LIKE match, handle it separately
        if ($request->has('search') and !empty($request->input('search'))) {
            $search->where('s.descripcion', 'like', '%' . $request->input('search') . '%');
        }
        //query
        $data = $search->orderBy($sort, $order)->limit($rows)->offset($offset)->get();
        //var_dump($paises); //toSql()
        //array
        $result = array(); $items = array();
        //fetch
        foreach ($data as $u) {
            $object = new \stdClass();
            $object->id = $u->id;
            $object->tipo = $u->tipo;
            $object->categoria = $u->categoria;
            $object->descripcion = $u->descripcion;
            $object->puntaje = $u->puntaje;
            //push
            array_push($items, $object);
        }
        //result
        $result["total"] = $count;
        $result["rows"] = $items;
        //return
        return response()->json($result, 200);
    }
    //create
    public function create(Request $request)
    {
        //validate incoming request
        $this->validate($request, [
            'categoria' => 'required|integer',
            'descripcion' => 'required|string',
            'puntaje' => 'required|integer'
        ]);
        //trye
        try {
            //model
            $data = new Scale;
            $data->fk_data_escala_tipo = intval($request->input('categoria'));
            $data->descripcion = strtoupper($request->input('descripcion'));
            $data->puntaje = intval($request->input('puntaje'));
            //save
            $data->save();
            //return successful response
            return response()->json(['data' => $data, 'message' => 'CREATED'], 201);
            //end
        } catch (\Exception $e) {
            //return error message
            return response()->json(['message' => 'Registration failed'], 409);
        }
    }
    //update
    public function update(Request $request, $id)
    {
        //validate incoming request
        $this->validate($request, [
            'categoria' => 'required|integer',
            'descripcion' => 'required|string',
            'puntaje' => 'required|integer'
        ]);
        //trye
        try {
            //find
            $data = Scale::findOrFail($id);
            $data->update([
                'fk_data_escala_tipo' => intval($request->input('categoria')),
                'descripcion' => strtoupper($request->input('descripcion')),
                'puntaje' => intval($request->input('puntaje'))
            ]);
            //return successful response
            return response()->json(['data' => $data, 'message' => 'UPDATED'], 201);
            //end
        } catch (\Exception $e) {
            //return error message
            return response()->json(['message' => 'Updated Failed!'], 409);
        }
    }
    //delete
    /*public function delete($id)
    {
        //trye
        try {
            //find
            $data = Scale::findOrFail($id);
            $data->delete();
            //return successful response
            return response()->json(['message' => 'DELETED'], 201);
            //end
        } catch (\Exception $e) {
            //return error message
            return response()->json(['message' => 'Deleted Failed!'], 409);
        }
    }*/
}
